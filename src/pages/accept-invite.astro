---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<BaseLayout title="Aceptar Invitación - Nadamos con la Diversidad">
  <Header />
  <main class="flex-grow py-16 px-4">
    <div class="container mx-auto max-w-2xl">
      <div class="bg-gray-800 p-8 rounded-lg">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-8 text-white">
          Aceptar Invitación
        </h1>
        
        <div id="accept-invite-container" class="text-center">
          <p class="text-gray-300 mb-6">
            Estás a punto de aceptar una invitación para acceder al panel de administración.
          </p>
          <p class="text-gray-400 text-sm mb-8">
            Por favor, completa el formulario para crear tu cuenta y establecer tu contraseña.
          </p>
          
          <!-- El formulario se cargará aquí automáticamente por Netlify Identity -->
          <div id="netlify-identity-widget"></div>
          
          <div id="loading-message" class="text-gray-400">
            Cargando formulario...
          </div>
        </div>
        
        <div id="error-message" class="hidden mt-6 p-4 bg-red-900 border border-red-700 rounded-lg text-red-200">
          <p class="font-semibold mb-2">Error al procesar la invitación</p>
          <p id="error-text" class="text-sm"></p>
          <p class="text-sm mt-4">
            Si el problema persiste, contacta con el administrador o intenta acceder directamente desde el 
            <a href="/admin" class="text-rainbow-3 hover:text-rainbow-2 underline">panel de administración</a>.
          </p>
        </div>
        
        <div id="success-message" class="hidden mt-6 p-4 bg-green-900 border border-green-700 rounded-lg text-green-200">
          <p class="font-semibold mb-2">¡Invitación aceptada correctamente!</p>
          <p class="text-sm mb-4">Tu cuenta ha sido creada. Ahora puedes acceder al panel de administración.</p>
          <a 
            href="/admin" 
            class="inline-block bg-rainbow-3 text-gray-900 font-bold px-6 py-3 rounded-lg hover:bg-rainbow-2 transition-colors"
          >
            Ir al Panel de Administración
          </a>
        </div>
      </div>
    </div>
  </main>
  <Footer />
</BaseLayout>

<script>
  // Script para manejar la aceptación de invitaciones de Netlify Identity
  (function() {
    // Obtener parámetros de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const invite = urlParams.get('invite');
    
    // Verificar si hay parámetros de invitación
    if (!token && !invite) {
      document.getElementById('error-message').classList.remove('hidden');
      document.getElementById('error-text').textContent = 'No se encontraron parámetros de invitación válidos en la URL.';
      document.getElementById('loading-message').style.display = 'none';
      return;
    }
    
    // Cargar Netlify Identity si está disponible
    if (window.netlifyIdentity) {
      // Netlify Identity ya está cargado
      handleInvite();
    } else {
      // Esperar a que se cargue Netlify Identity
      window.addEventListener('netlify-identity-loaded', handleInvite);
      
      // Si no se carga en 5 segundos, mostrar error
      setTimeout(() => {
        if (!window.netlifyIdentity) {
          document.getElementById('error-message').classList.remove('hidden');
          document.getElementById('error-text').textContent = 'No se pudo cargar Netlify Identity. Asegúrate de que esté habilitado en tu sitio de Netlify.';
          document.getElementById('loading-message').style.display = 'none';
        }
      }, 5000);
    }
    
    function handleInvite() {
      try {
        // Ocultar mensaje de carga
        document.getElementById('loading-message').style.display = 'none';
        
        // Abrir el widget de Netlify Identity con la invitación
        if (token) {
          window.netlifyIdentity.on('accept', () => {
            // Invitación aceptada
            document.getElementById('success-message').classList.remove('hidden');
            document.getElementById('accept-invite-container').classList.add('hidden');
          });
          
          window.netlifyIdentity.on('error', (err) => {
            // Error al aceptar invitación
            document.getElementById('error-message').classList.remove('hidden');
            document.getElementById('error-text').textContent = err.message || 'Error desconocido al procesar la invitación.';
          });
          
          // Abrir el modal de aceptación
          window.netlifyIdentity.open('invite');
        } else if (invite) {
          // Manejar invitación por email
          window.netlifyIdentity.on('accept', () => {
            document.getElementById('success-message').classList.remove('hidden');
            document.getElementById('accept-invite-container').classList.add('hidden');
          });
          
          window.netlifyIdentity.open('invite');
        }
      } catch (error) {
        document.getElementById('error-message').classList.remove('hidden');
        document.getElementById('error-text').textContent = error.message || 'Error al procesar la invitación.';
        document.getElementById('loading-message').style.display = 'none';
      }
    }
  })();
</script>

<!-- Script de Netlify Identity -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<style>
  #netlify-identity-widget {
    min-height: 200px;
  }
  
  #loading-message {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: .5;
    }
  }
</style>

